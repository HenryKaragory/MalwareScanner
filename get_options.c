#include <string.h>
#include <stdlib.h>
#include <stdio.h>

#include "./include/malware_finder_options.h"
#include "./include/mware_sys_call.h"
#include "./include/utility.h"

PersistentOptions *get_persistent_options(){
	PersistentOptions *pers_options = malloc(sizeof(PersistentOptions));

	// Read in the persistent options from the .config file
	FILE *file = fopen("./config/malware_scanner.config", "r");
	if(file != NULL){
		char key_value_line[255];
		while(fgets(key_value_line, sizeof(key_value_line), file)){
			char *newline = strchr(key_value_line, '\n' );
			if ( newline ){
			  *newline = 0;
			}

			char *key = strtok(key_value_line, "=");
			char *char_value = strtok(NULL, "=");
			int value;

			if(strcmp(char_value, "YES") == 0){
				value = TRUE;
			}else{
				value = FALSE;
			}

			if(strcmp(key, "PRINT_MWARE_INFO") == 0){
				pers_options->print_mware_info = value;
			}else if(strcmp(key, "MALWARE_NAME") == 0){
				strcpy(pers_options->mware_to_find_name, char_value);
			}
		}
	}

	fclose(file);
	return pers_options;
}

MalwareFinderOptions *get_mware_options_from_args(int argc, char *argv[]){
	MalwareFinderOptions *mware_options;
	mware_options = (MalwareFinderOptions *) malloc(sizeof(MalwareFinderOptions));
 	strcpy(mware_options->mware_to_find_name, argv[1]);
	mware_options->search_running_processes = TRUE;
	mware_options->sys_call_offset = 184;
 	return mware_options;
}

MalwareFinderOptions *get_mware_options_from_prompt(){
	MalwareFinderOptions *mware_options;
	mware_options = (MalwareFinderOptions *) malloc(sizeof(MalwareFinderOptions));

	printf("Enter the name of the malware you are scanning for: ");
	scanf("%s", mware_options->mware_to_find_name);

	// Ask the user if they will search the currently running processes on the system
	printf("Would you like to search the list of running processes (yes/no): ");
	char char_search_running_processes[255];
	scanf("%s", char_search_running_processes);
	while(strcmp(char_search_running_processes, "yes") != 0 && strcmp(char_search_running_processes, "no") != 0) {
		printf("Bad input.\n");
		printf("Would you like to search the list of running processes (yes/no): ");
		scanf("%s", char_search_running_processes);
	}

	if(strcmp(char_search_running_processes, "yes") == 0){
		mware_options->search_running_processes = TRUE;
	}else{ 
		mware_options->search_running_processes = FALSE;
	}

	printf("Enter the offset of the system call that you loaded: ");
	int scall_offset;
	scanf(" %i", &scall_offset);
	mware_options->sys_call_offset = scall_offset;

	return mware_options;
}
