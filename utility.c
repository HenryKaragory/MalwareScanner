#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "./include/malware_finder_options.h"
#include "./include/mware_sys_call.h"
#include "./include/utility.h"

int inform_user(void){

	return 0;
}

int persist_data(struct PersistentOptions *pers_options){
	FILE* optionsFile = fopen("./config/malware_scanner.config","w");
	char* strline = NULL;
	size_t length = 0;
	if(optionsFile == NULL){
		exit(EXIT_FAILURE);
	}
	
	fprintf(optionsFile, "PRINT_MWARE_INFO=");
	switch(pers_options->print_mware_info){
		case TRUE:
			fprintf(optionsFile,"YES\n");
		break;
		case FALSE:
			fprintf(optionsFile,"NO\n");
		break;
		case ABSENT:
			fprintf(optionsFile,"NO\n");
		break;
		default:
		break;
	}
	fprintf(optionsFile, "MALWARE_NAME=%s\n", pers_options->mware_to_find_name);
	fclose(optionsFile);
}

void strip_newline(char *str) {
	int i;
	for(i=0;i++;){
		if(str[i]=='\n'){
			str[i] = '\0';
			break;
		}
	}
}

void grep_mware(char *mware_regex){
	// Redirect stdout to grep_output
	freopen("./output/grep_output.txt", "w+", stdout);
	char command[50];
    	strcpy(command, "ps aux | awk '{print $2, $11}' | grep ");
    	strcat(command, mware_regex);
    	system(command);
	freopen("/dev/tty", "w", stdout);
	
	printf("\nI found some malware matching your parameters, here it is: \n\n");
	strcpy(command, "ps aux | awk 'NR == 1 || /");
	strcat(command, mware_regex);
	strcat(command, "/'");
	system(command);
	printf("\n");
}

void add_m_node_to_list(int pid, char *name, struct MalwareProcessNode **mware_list_head) {
    struct MalwareProcessNode *new_m_node = (struct MalwareProcessNode *) malloc(sizeof(struct MalwareProcessNode));
    new_m_node->pid = pid;
    strcpy(new_m_node->name, name);
    new_m_node->next_mware_node = *mware_list_head;
    *mware_list_head = new_m_node;
}

void free_mware_list(struct MalwareProcessNode *mware_list) {
	struct MalwareProcessNode *m_node_tmp;
	while(mware_list != NULL){
		m_node_tmp = mware_list;
		mware_list = mware_list->next_mware_node;
		free(m_node_tmp);
	}
}

struct MalwareProcessNode *obtain_mware_list(void){
	struct MalwareProcessNode *mware_list = NULL;
	FILE * fp;
	char *name;
	char *pid_char;
	int pid;
    char * line = NULL;
    size_t len = 0;

    fp = fopen("./output/grep_output.txt", "r");
    if (fp == NULL)
        exit(EXIT_FAILURE);

    while (getline(&line, &len, fp) != -1) {
    	char *newline = strchr(line, '\n' );
		if ( newline ){
		  *newline = 0;
		}

    	pid_char = strtok(line, " ");
    	pid = atoi(pid_char);
    	name = strtok(NULL, " ");

    	add_m_node_to_list(pid, name, &mware_list);
    }
    fclose(fp);
    return mware_list;
}

void print_all_m_nodes(struct MalwareProcessNode *mware_list) {
	struct MalwareProcessNode *m_node = mware_list;
	while(m_node != NULL){
		printf("KILL: %i | PID: %i | PROCESS NAME: %s \n", m_node->kill_process, m_node->pid, m_node->name);
		m_node = m_node->next_mware_node;
	}
}

void determine_processes_to_kill(MalwareProcessNode *mware_list) {
	char *line;
	size_t len;
	printf("Process names will be displayed.\n");
	printf("Enter y/n to kill or not kill the process.\n");
	printf("Enter m for more information about the process.\n\n");

	while ((getchar()) != '\n');

	struct MalwareProcessNode *m_node = mware_list;
	while(m_node != NULL) {
		line = NULL;
		len = 0;

		printf("PROCESS NAME: %s \n", m_node->name);
		
		getline(&line, &len, stdin);
		char *newline = strchr(line, '\n' );
		if ( newline ){
		  *newline = 0;
		}

		if(strcmp(line, "y") == 0) {
			m_node->kill_process = TRUE;
			m_node = m_node->next_mware_node;

		} else if(strcmp(line, "n") == 0) {
			m_node->kill_process = FALSE;
			m_node = m_node->next_mware_node;

		} else if(strcmp(line, "m") == 0) {
			printf("\n");
			char pid_char[8];
			char command[511];
			sprintf(pid_char, "%i", m_node->pid);
			strcpy(command, "ps u -p ");
			strcat(command, pid_char);
			system(command);
		}

		printf("\n");
	}
}
