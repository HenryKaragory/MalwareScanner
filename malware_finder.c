#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "include/malware_finder_options.h"
#include "include/mware_sys_call.h"
#include "include/utility.h"

int main(int argc, char *argv[]){

	// Data structures to be used in the program.
	MalwareFinderOptions *mware_options;
	PersistentOptions *pers_options;
	char use_pers_options_response[255];
	char save_pers_options_response[255];

	/*
	*  Get the persistent options from the user.
	*/
	pers_options = get_persistent_options();
	printf("Would you like to use saved preferences?(yes/no): ");
	scanf("%s",use_pers_options_response);
	while(strcmp(use_pers_options_response,"yes") != 0 && strcmp(use_pers_options_response,"no") != 0){
		printf("Bad input.");
		printf("Would you like to use saved preferences?(yes/no):");
		scanf("%s",use_pers_options_response);
	}	
	
	while ((getchar()) != '\n');
	// Path #1 - User enters the information from command line arguments (.e. argc > 1)
	// Path #2 - User enters the information from prompts given by the program
	if(argc > 1) {
		mware_options = get_mware_options_from_args(argc, argv);
	} else {
		mware_options = get_mware_options_from_prompt();
		while ((getchar()) != '\n');
	}

	if(strcmp(use_pers_options_response, "yes") == 0){
		strcat(mware_options->mware_to_find_name,"|");
		strcat(mware_options->mware_to_find_name, pers_options->mware_to_find_name);
	}

	grep_mware(mware_options->mware_to_find_name); 
	struct MalwareProcessNode *mware_list_head = obtain_mware_list();
	determine_processes_to_kill(mware_list_head);

	/* 
	*  At this point we have all the information we need to make the system call.
	*  Make the system call.
	*/
	unsigned long mware_result =  mware_scan(mware_options, mware_list_head);
	

	
	// Copy the name that was searched to persistent options.
	strcpy(pers_options->mware_to_find_name, mware_options->mware_to_find_name);
	
	// Determine if the user would like the save their settings
	printf("Would you like to save your settings to the config file?(yes/no): ");
	scanf("%s", save_pers_options_response);
	while(strcmp(save_pers_options_response,"yes") != 0 && strcmp(save_pers_options_response,"no") != 0){
		printf("Bad input.\n");
		printf("Would you like to use saved preferences?(yes/no):");
		scanf("%s", save_pers_options_response);
	}	
	while ((getchar()) != '\n');
 	
 	// Persist options
	if(strcmp(save_pers_options_response, "yes") == 0) {
		persist_data(pers_options);
	}

 	// Free memory
	free_mware_list(mware_list_head);
	free(mware_options);
	free(pers_options);

	return 0;

}
