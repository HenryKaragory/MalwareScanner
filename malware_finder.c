#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "include/malware_finder_options.h"
#include "include/mware_sys_call.h"
#include "include/utility.h"

int main(int argc, char *argv[]){

	// Data structures to be used in the program.
	MalwareFinderOptions *mware_options;
	PersistentOptions *pers_options;
	char response[255];
	/*
	*  Let's consider a couple ways for the user to enter their data:
	*  They could pass in the malware name and what information they would
	*  like returned from command line arguments or they could be prompted by 
	*  the program to enter that information from the command line.
	*  Also, we could use a malware_finder.config file to define persistent options.
	*/

	// In both paths of execution we need to read in the persistent options from malware_finder.config.

	pers_options = get_persistent_options();
	printf("Would you like to use saved preferences?(yes/no):");
	scanf("%s",response);
	while(strcmp(response,"yes") != 0 && strcmp(response,"no") != 0){
		printf("Bad input.");
		printf("Would you like to use saved preferences?(yes/no):");
		scanf("%s",response);
	}	
	
	while ((getchar()) != '\n');
	// Path #1 - User enters the information from command line arguments (.e. argc > 1)
	// TODO: Fill up the mware_options struct with stuff we have prompted from the user
	// Path #2 - User enters the information from prompts given by the program
	if(argc > 1) {
		mware_options = get_mware_options_from_args(argc, argv);
	} else {
		mware_options = get_mware_options_from_prompt();
		while ((getchar()) != '\n');
	}

	if(strcmp(response, "yes") == 0){
		strcat(mware_options->mware_to_find_name,"|");
		strcat(mware_options->mware_to_find_name, pers_options->mware_to_find_name);
	}

	grep_mware(mware_options->mware_to_find_name); // NEED TO SUPPORT both pers_options->name and mware_options->name
	struct MalwareProcessNode *mware_list_head = obtain_mware_list();
	determine_processes_to_kill(mware_list_head);

	/* 
	*  At this point we have all the information we need to make the system call.
	*  Make the system call.
	*/
	unsigned long mware_result =  mware_scan(mware_options, mware_list_head);

	// Print all of the m_nodes that were found for debugging
	print_all_m_nodes(mware_list_head);
	
	// /*
	// *  The system call ran successfully, now we need to present the user with 
	// *  information about malware that was found and prompt them for additional
	// *  information about what to do with this malware.
	// */
	//inform_user(sys_call_result);

	// /* 
	// *  End program execution, maybe persist some user data or information
	// *  about the malware that was found
	// */
	strcpy(pers_options->mware_to_find_name, mware_options->mware_to_find_name);
	persist_data(pers_options);

	free_mware_list(mware_list_head);
	free(mware_options);
	free(pers_options);

	return 0;

}
